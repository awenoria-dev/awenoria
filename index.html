<script>
// ====== Awenoria : appel du Worker Cloudflare (analyse r√©elle) ======
const WORKER_URL = "https://awenoria.bmavcontact.workers.dev/analyze";

function normalizeUrl(u){
  if(!u) return "";
  u = u.trim();
  if(!/^https?:\/\//i.test(u)) u = "https://" + u;
  return u;
}
function pct(n){ return Number.isFinite(n) ? `${Math.round(n)}%` : "‚Äî"; }

async function analyser() {
  const input = document.getElementById('url');
  let site = normalizeUrl(input.value);
  if (!site) { alert("Merci d'entrer une URL."); return; }

  const box = document.getElementById('resultat');
  box.style.display = 'block';
  box.innerHTML = `<p>Analyse en cours‚Ä¶</p>`;

  try {
    const res = await fetch(`${WORKER_URL}?url=${encodeURIComponent(site)}`, {
      headers: { "accept": "application/json" }
    });
    const data = await res.json();

    if (!res.ok || data.ok === false) {
      throw new Error(data?.error || `Erreur serveur (${res.status})`);
    }

    const s = data.scores || {};
    const rgpd = data.rgpd || {};
    const legal = data.legal || {};
    const a11y = data.a11y || {};

    box.innerHTML = `
      <h2>R√©sultats pour <b>${data.finalUrl || site}</b></h2>
      <p><b>Score global :</b> ${pct(s.global)}</p>
      <ul style="list-style:none;padding:0;line-height:1.9">
        <li>üîπ <b>RGPD</b> : ${pct(s.rgpd)}
            ${rgpd.policyLink ? "‚Ä¢ Politique d√©tect√©e" : "‚Ä¢ Politique non d√©tect√©e"}
            ${rgpd.cookiesWords ? "‚Ä¢ Cookies" : ""}</li>
        <li>üîπ <b>Mentions l√©gales</b> : ${pct(s.mentions)}
            ${legal.mentionsLink ? "‚Ä¢ Lien d√©tect√©" : "‚Ä¢ Non d√©tect√©"}
            ${legal.cgvLink ? "‚Ä¢ CGV" : ""} ${legal.cguLink ? "‚Ä¢ CGU" : ""}</li>
        <li>üîπ <b>Accessibilit√©</b> : ${pct(s.accessibilite)}
            ‚Ä¢ ALT: ${a11y.imgWithAlt || 0}/${a11y.imgCount || 0}
            ${a11y.hasAria ? "‚Ä¢ ARIA" : ""} ${a11y.hasLandmarks ? "‚Ä¢ rep√®res" : ""}</li>
      </ul>
      <p style="margin-top:10px;color:#6b7280">
        Analyse bas√©e sur le contenu r√©el de la page via Cloudflare Worker (aucun stockage).  
        La version compl√®te ajoutera des contr√¥les approfondis (contrastes, scripts cookies, PDF, etc.) et un rapport t√©l√©chargeable.
      </p>
    `;
    box.scrollIntoView({behavior:'smooth', block:'center'});
  } catch (e) {
    box.innerHTML = `<p style="color:#b91c1c"><b>Erreur :</b> ${e.message}</p>`;
  }
}
</script>
