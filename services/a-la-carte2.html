<script>
/* === Injection header/footer + CSS/JS robustes (multi-chemins) === */
(function(){
  const isGh = /github\.io$/.test(location.hostname);
  let base = "/";
  if (isGh) {
    const parts = location.pathname.split("/").filter(Boolean);
    base = parts.length ? `/${parts[0]}/` : "/";
  }
  const tryPaths = (p) => {
    const clean = p.replace(/^\//,"");
    return [ base+clean, "./"+clean, "../"+clean ];
  };
  async function fetchText(paths){
    const list = Array.isArray(paths) ? paths : [paths];
    const queue = list.flatMap(tryPaths);
    for (const url of queue){
      try{
        const res = await fetch(url, {cache:"no-cache"});
        if(res.ok){ console.log("[INCLUDES] OK", url); return res.text(); }
        else console.warn("[INCLUDES] HTTP", res.status, url);
      }catch(e){ console.warn("[INCLUDES] ERR", url, e); }
    }
    throw new Error("Introuvable: "+list.join(", "));
  }
  function fixRootUrls(container){
    container.querySelectorAll('a[href^="/"], img[src^="/"], link[href^="/"], script[src^="/"]')
      .forEach(el=>{
        const attr = el.hasAttribute("href") ? "href" : "src";
        const val = el.getAttribute(attr);
        if(/^\/\//.test(val)) return;
        el.setAttribute(attr, base + val.replace(/^\//,""));
      });
  }
  async function ensureCss(){
    const el = document.getElementById("awenoria-css");
    const paths = ["assets/awenoria.css","/assets/awenoria.css"];
    let ok = false;

    function cssLoaded(){
      try{
        // si au moins 1 feuille contient des règles, on considère OK
        return [...document.styleSheets].some(s=>{
          try{ return (s.ownerNode && s.ownerNode.id==="awenoria-css" && s.cssRules && s.cssRules.length>0); }
          catch(e){ return false; }
        });
      }catch(e){ return false; }
    }

    if (cssLoaded()) return true;

    for(const url of paths.flatMap(tryPaths)){
      await new Promise((r)=>setTimeout(r,0));
      el.setAttribute("href", url);
      await new Promise((r)=>setTimeout(r,120));
      if (cssLoaded()){ console.log("[CSS] OK", url); ok = true; break; }
      console.warn("[CSS] tentative échouée", url);
    }
    if (!ok) console.error("[CSS] awenoria.css introuvable");
    return ok;
  }

  async function ensureNavJs(){
    // Charge nav.js une seule fois
    if (window.__awenoria_nav_ready) return;
    const code = await fetchText(["assets/nav.js","nav.js","/assets/nav.js"]).catch(()=>null);
    if (!code){ console.error("[NAV] nav.js introuvable"); return; }
    const s = document.createElement("script");
    // Si le fichier contient import/export, passe en module
    if (/\b(import|export)\b/.test(code)) s.type = "module";
    s.textContent = code;
    document.body.appendChild(s);
    window.__awenoria_nav_ready = true;
  }

  async function inject(part, mountId){
    const html = await fetchText([`partials/${part}.html`, `${part}.html`, `/partials/${part}.html`]);
    const mount = document.getElementById(mountId);
    if (!mount) return;
    mount.innerHTML = html;
    fixRootUrls(mount);
  }

  document.addEventListener("DOMContentLoaded", async ()=>{
    try{
      await ensureCss();                    // 1) s’assure de la CSS
      await inject("header", "header");     // 2) injecte le header
      await ensureNavJs();                  // 3) charge nav.js (menu)
      await inject("footer", "footer");     // 4) injecte le footer
      console.log("[INCLUDES] done");
    }catch(e){
      console.error("[INCLUDES] erreur", e);
    }
  });
})();
</script>
